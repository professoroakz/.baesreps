#!/usr/bin/env bash
# .baesreps functions - Helper functions for Bae's Secrets & Reps

# =============================================================================
# INPUT VALIDATION
# =============================================================================

# Validate name input - prevent path traversal and special characters
_baesreps_validate_name() {
	local name="$1"
	if [ -z "$name" ]; then
		echo "Error: Name cannot be empty" >&2
		return 1
	fi
	if [[ "$name" == *".."* ]] || [[ "$name" == *"/"* ]] || [[ "$name" == *"\\"* ]]; then
		echo "Error: Name cannot contain path traversal characters" >&2
		return 1
	fi
	if [[ "$name" =~ [^a-zA-Z0-9_-] ]]; then
		echo "Error: Name can only contain alphanumeric characters, underscores, and hyphens" >&2
		return 1
	fi
	return 0
}

# Escape string for JSON
_baesreps_json_escape() {
	local str="$1"
	# Escape backslashes, double quotes, and control characters
	str="${str//\\/\\\\}"
	str="${str//\"/\\\"}"
	printf '%s' "$str"
}

# =============================================================================
# SECRET FUNCTIONS
# =============================================================================

# Manage secrets
function baesreps-secret() {
	local cmd="${1:-help}"
	shift

	case "$cmd" in
		stash)
			if ! _baesreps_validate_name "$1"; then
				return 1
			fi
			local name="$1"
			local escaped_name=$(_baesreps_json_escape "$name")
			echo "üîí Stashing secret: $name"
			mkdir -p "$BAESREPS_SECRETS_DIR/$name"
			printf '{"name": "%s", "status": "stashed", "created": "%s"}\n' "$escaped_name" "$(date -Iseconds)" > "$BAESREPS_SECRETS_DIR/$name/meta.json"
			;;
		list)
			echo "üìã Stashed Secrets:"
			ls -1 "$BAESREPS_SECRETS_DIR" 2>/dev/null || echo "  No secrets found"
			;;
		status)
			if [ -n "$1" ]; then
				if ! _baesreps_validate_name "$1"; then
					return 1
				fi
				cat "$BAESREPS_SECRETS_DIR/$1/meta.json" 2>/dev/null || echo "Secret not found: $1"
			else
				echo "Usage: baesreps-secret status <secret-name>"
			fi
			;;
		shred)
			if [ -n "$1" ]; then
				if ! _baesreps_validate_name "$1"; then
					return 1
				fi
				local name="$1"
				if [ -d "$BAESREPS_SECRETS_DIR/$name" ]; then
					echo "üóëÔ∏è Shredding secret: $name"
					rm -rf "$BAESREPS_SECRETS_DIR/$name"
				else
					echo "Secret not found: $name"
				fi
			else
				echo "Usage: baesreps-secret shred <secret-name>"
			fi
			;;
		*)
			echo "üíú .baesreps Secret Manager"
			echo "Usage: baesreps-secret <command> [args]"
			echo ""
			echo "Commands:"
			echo "  stash <name>   - Stash a new secret"
			echo "  list           - List all secrets"
			echo "  status <name>  - Show secret status"
			echo "  shred <name>   - Remove a secret"
			;;
	esac
}

# =============================================================================
# VAULT FUNCTIONS
# =============================================================================

# Manage vaults
function baesreps-vault() {
	local cmd="${1:-help}"
	shift

	case "$cmd" in
		create)
			if ! _baesreps_validate_name "$1"; then
				return 1
			fi
			local name="$1"
			local escaped_name=$(_baesreps_json_escape "$name")
			echo "üîê Creating vault: $name"
			mkdir -p "$BAESREPS_VAULTS_DIR/$name"
			printf '{"name": "%s", "status": "locked", "created": "%s"}\n' "$escaped_name" "$(date -Iseconds)" > "$BAESREPS_VAULTS_DIR/$name/vault.json"
			;;
		list)
			echo "üóÑÔ∏è Available Vaults:"
			ls -1 "$BAESREPS_VAULTS_DIR" 2>/dev/null || echo "  No vaults found"
			;;
		unlock)
			if [ -n "$1" ]; then
				if ! _baesreps_validate_name "$1"; then
					return 1
				fi
				local name="$1"
				if [ -d "$BAESREPS_VAULTS_DIR/$name" ]; then
					export BAESREPS_CURRENT_VAULT="$name"
					cd "$BAESREPS_VAULTS_DIR/$name"
					echo "üîì Unlocked vault: $name"
				else
					echo "Vault not found: $name"
				fi
			else
				echo "Usage: baesreps-vault unlock <name>"
			fi
			;;
		lock)
			unset BAESREPS_CURRENT_VAULT
			cd "$HOME"
			echo "üîí Locked current vault"
			;;
		*)
			echo "üíú .baesreps Vault Manager"
			echo "Usage: baesreps-vault <command> [args]"
			echo ""
			echo "Commands:"
			echo "  create <name>  - Create a new vault"
			echo "  list           - List all vaults"
			echo "  unlock <name>  - Unlock a vault"
			echo "  lock           - Lock current vault"
			;;
	esac
}

# =============================================================================
# REP FUNCTIONS
# =============================================================================

# Rep management (routines/repetitions)
function baesreps-rep() {
	local cmd="${1:-help}"
	shift

	case "$cmd" in
		create)
			if [ -z "$1" ]; then
				echo "Error: Rep name cannot be empty" >&2
				return 1
			fi
			local rep_id=$(date +%s)
			local escaped_name=$(_baesreps_json_escape "$1")
			echo "üìù Creating rep: $1 (ID: $rep_id)"
			mkdir -p "$BAESREPS_REPS_DIR"
			printf '{"id": "%s", "name": "%s", "status": "pending", "created": "%s"}\n' "$rep_id" "$escaped_name" "$(date -Iseconds)" > "$BAESREPS_REPS_DIR/$rep_id.json"
			;;
		list)
			echo "üìã Reps:"
			if ls "$BAESREPS_REPS_DIR"/*.json >/dev/null 2>&1; then
				for rep in "$BAESREPS_REPS_DIR"/*.json; do
					[ -f "$rep" ] && cat "$rep"
				done
			else
				echo "  No reps found"
			fi
			;;
		execute)
			echo "üöÄ Executing rep: $1"
			# Placeholder for rep execution logic
			;;
		*)
			echo "üíú .baesreps Rep Manager"
			echo "Usage: baesreps-rep <command> [args]"
			echo ""
			echo "Commands:"
			echo "  create <name>  - Create a new rep"
			echo "  list           - List all reps"
			echo "  execute <id>   - Execute a rep"
			;;
	esac
}

# =============================================================================
# NOTE FUNCTIONS
# =============================================================================

# Note creation
function baesreps-note() {
	local cmd="${1:-help}"
	shift

	case "$cmd" in
		create)
			echo "üìù Creating note: $*"
			mkdir -p "$BAESREPS_NOTES_DIR"
			local note_file="$BAESREPS_NOTES_DIR/note-$(date +%Y%m%d-%H%M%S).md"
			echo "# Note - $(date)" > "$note_file"
			echo "" >> "$note_file"
			echo "$*" >> "$note_file"
			echo "Created: $note_file"
			;;
		journal)
			echo "üìñ Creating journal entry"
			mkdir -p "$BAESREPS_NOTES_DIR/journal"
			local journal_file="$BAESREPS_NOTES_DIR/journal/$(date +%Y-%m-%d).md"
			echo "# Journal - $(date +%Y-%m-%d)" >> "$journal_file"
			echo "" >> "$journal_file"
			${EDITOR:-vim} "$journal_file"
			;;
		memo)
			echo "‚úçÔ∏è Quick memo: $*"
			mkdir -p "$BAESREPS_NOTES_DIR/memos"
			local memo_file="$BAESREPS_NOTES_DIR/memos/memo-$(date +%Y%m%d-%H%M%S).md"
			echo "$*" > "$memo_file"
			echo "Memo saved: $memo_file"
			;;
		*)
			echo "üíú .baesreps Note Creator"
			echo "Usage: baesreps-note <type> [content]"
			echo ""
			echo "Types:"
			echo "  create <text>  - Create a note"
			echo "  journal        - Open journal for today"
			echo "  memo <text>    - Quick memo"
			;;
	esac
}

# =============================================================================
# UTILITY FUNCTIONS
# =============================================================================

# Create a directory and enter it
function mkd() {
	mkdir -p "$@" && cd "$_"
}

# Show .baesreps status
function baesreps-status() {
	echo "üíú .baesreps Status"
	echo "==================="
	echo ""
	echo "üìÅ Directories:"
	echo "  Home:    $BAESREPS_HOME"
	echo "  Secrets: $BAESREPS_SECRETS_DIR"
	echo "  Vaults:  $BAESREPS_VAULTS_DIR"
	echo "  Reps:    $BAESREPS_REPS_DIR"
	echo "  Notes:   $BAESREPS_NOTES_DIR"
	echo ""
	echo "üîí Secrets: $(ls -1 "$BAESREPS_SECRETS_DIR" 2>/dev/null | wc -l)"
	echo "üîê Vaults:  $(ls -1 "$BAESREPS_VAULTS_DIR" 2>/dev/null | wc -l)"
	echo "üìù Reps:    $(ls -1 "$BAESREPS_REPS_DIR"/*.json 2>/dev/null | wc -l)"
	echo ""
	if [ -n "$BAESREPS_CURRENT_VAULT" ]; then
		echo "üìç Current Vault: $BAESREPS_CURRENT_VAULT"
	fi
}

# Initialize .baesreps directories
function baesreps-init() {
	echo "üíú Initializing .baesreps environment..."
	mkdir -p "$BAESREPS_SECRETS_DIR"
	mkdir -p "$BAESREPS_VAULTS_DIR"
	mkdir -p "$BAESREPS_REPS_DIR"
	mkdir -p "$BAESREPS_NOTES_DIR"
	mkdir -p "$BAESREPS_CACHE"
	echo "‚úÖ .baesreps environment initialized!"
	baesreps-status
}
