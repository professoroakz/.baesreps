#!/usr/bin/env bash
# baesreps-secret - Secret management executable for .baesreps
# Wrapper for the baesreps-secret function with additional CLI features
#
# Usage: baesreps-secret <command> [args]

set -e

BAESREPS_SECRETS_DIR="${BAESREPS_SECRETS_DIR:-$HOME/secrets}"

# Color codes
PURPLE='\033[0;35m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

# =============================================================================
# INPUT VALIDATION
# =============================================================================

validate_name() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Error: Name cannot be empty${NC}" >&2
        return 1
    fi
    if [[ "$name" == *".."* ]] || [[ "$name" == *"/"* ]] || [[ "$name" == *"\\"* ]]; then
        echo -e "${RED}Error: Name cannot contain path traversal characters${NC}" >&2
        return 1
    fi
    if [[ "$name" =~ [^a-zA-Z0-9_-] ]]; then
        echo -e "${RED}Error: Name can only contain alphanumeric characters, underscores, and hyphens${NC}" >&2
        return 1
    fi
    return 0
}

json_escape() {
    local str="$1"
    str="${str//\\/\\\\}"
    str="${str//\"/\\\"}"
    printf '%s' "$str"
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_stash() {
    local name="$1"
    
    if ! validate_name "$name"; then
        return 1
    fi
    
    local escaped_name=$(json_escape "$name")
    echo -e "${PURPLE}üîí Stashing secret: $name${NC}"
    mkdir -p "$BAESREPS_SECRETS_DIR/$name"
    printf '{"name": "%s", "status": "stashed", "created": "%s"}\n' "$escaped_name" "$(date -Iseconds)" > "$BAESREPS_SECRETS_DIR/$name/meta.json"
    echo -e "${GREEN}‚úÖ Secret stashed: $name${NC}"
}

cmd_list() {
    echo -e "${PURPLE}üìã Stashed Secrets:${NC}"
    if [ -d "$BAESREPS_SECRETS_DIR" ]; then
        local found=0
        for secret_dir in "$BAESREPS_SECRETS_DIR"/*/; do
            if [ -f "${secret_dir}meta.json" ]; then
                local name=$(basename "$secret_dir")
                local json_content=$(cat "${secret_dir}meta.json" | tr '\n' ' ')
                local status=$(echo "$json_content" | grep -oP '"status"\s*:\s*"\K[^"]+' || echo "unknown")
                echo -e "  üîê ${CYAN}$name${NC} [$status]"
                found=1
            fi
        done
        if [ $found -eq 0 ]; then
            echo "  No secrets found"
        fi
    else
        echo "  No secrets found"
    fi
}

cmd_status() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo "Usage: baesreps-secret status <secret-name>"
        return 1
    fi
    
    if ! validate_name "$name"; then
        return 1
    fi
    
    if [ -f "$BAESREPS_SECRETS_DIR/$name/meta.json" ]; then
        echo -e "${PURPLE}üîê Secret: $name${NC}"
        echo "---"
        cat "$BAESREPS_SECRETS_DIR/$name/meta.json"
        echo ""
    else
        echo -e "${RED}Secret not found: $name${NC}"
        return 1
    fi
}

cmd_shred() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo "Usage: baesreps-secret shred <secret-name>"
        return 1
    fi
    
    if ! validate_name "$name"; then
        return 1
    fi
    
    if [ -d "$BAESREPS_SECRETS_DIR/$name" ]; then
        echo -e "${RED}üóëÔ∏è Shredding secret: $name${NC}"
        rm -rf "$BAESREPS_SECRETS_DIR/$name"
        echo -e "${GREEN}‚úÖ Secret shredded${NC}"
    else
        echo -e "${RED}Secret not found: $name${NC}"
        return 1
    fi
}

show_help() {
    echo -e "${PURPLE}üíú .baesreps Secret Manager${NC}"
    echo "Usage: baesreps-secret <command> [args]"
    echo ""
    echo "Commands:"
    echo "  stash <name>   - Stash a new secret"
    echo "  list           - List all secrets"
    echo "  status <name>  - Show secret status"
    echo "  shred <name>   - Remove a secret"
    echo "  help           - Show this help"
    echo ""
    echo "Examples:"
    echo "  baesreps-secret stash api-key"
    echo "  baesreps-secret list"
    echo "  baesreps-secret status api-key"
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        stash)
            cmd_stash "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        status|get)
            cmd_status "$@"
            ;;
        shred|delete|remove)
            cmd_shred "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'baesreps-secret help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
