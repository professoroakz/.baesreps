#!/usr/bin/env bash
# baesreps - Main CLI for .baesreps hybrid application
# Reps derived from Bae's Secrets - Points calculator for projects and tasks
#
# Usage: baesreps <command> [args]

set -e

VERSION="1.0.0"
BAESREPS_HOME="${BAESREPS_HOME:-$HOME/.baesreps}"
BAESREPS_REPS_DIR="${BAESREPS_REPS_DIR:-$HOME/reps}"
BAESREPS_PROJECTS_DIR="${BAESREPS_PROJECTS_DIR:-$HOME/projects}"
BAESREPS_CARDS_DIR="${BAESREPS_CARDS_DIR:-$HOME/cards}"

# Color codes
PURPLE='\033[0;35m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

show_banner() {
    echo -e "${PURPLE}"
    echo "ðŸ’œ .baesreps - Reps derived from Bae's Secrets"
    echo "   Hybrid application for calculating reps (points)"
    echo -e "${NC}"
}

show_version() {
    echo "baesreps version $VERSION"
}

show_help() {
    show_banner
    echo "Usage: baesreps <command> [args]"
    echo ""
    echo "Commands:"
    echo "  init              Initialize .baesreps environment"
    echo "  status            Show current status and statistics"
    echo "  project           Manage projects (see: baesreps project help)"
    echo "  card              Manage cards (see: baesreps card help)"
    echo "  calc              Calculate reps/points (see: baesreps calc help)"
    echo "  secret            Manage secrets (see: baesreps secret help)"
    echo "  vault             Manage vaults (see: baesreps vault help)"
    echo "  rep               Manage reps (see: baesreps rep help)"
    echo "  note              Manage notes (see: baesreps note help)"
    echo "  version           Show version"
    echo "  help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  baesreps init                    # Initialize environment"
    echo "  baesreps project create myapp    # Create a new project"
    echo "  baesreps card add myapp task-1   # Add a card to project"
    echo "  baesreps calc total myapp        # Calculate total reps"
}

# =============================================================================
# COMMAND HANDLERS
# =============================================================================

cmd_init() {
    echo -e "${PURPLE}ðŸ’œ Initializing .baesreps environment...${NC}"
    
    mkdir -p "$BAESREPS_REPS_DIR"
    mkdir -p "$BAESREPS_PROJECTS_DIR"
    mkdir -p "$BAESREPS_CARDS_DIR"
    mkdir -p "${BAESREPS_SECRETS_DIR:-$HOME/secrets}"
    mkdir -p "${BAESREPS_VAULTS_DIR:-$HOME/vaults}"
    mkdir -p "${BAESREPS_NOTES_DIR:-$HOME/notes}"
    mkdir -p "${BAESREPS_CACHE:-$HOME/.cache/baesreps}"
    
    echo -e "${GREEN}âœ… .baesreps environment initialized!${NC}"
    cmd_status
}

cmd_status() {
    echo -e "${PURPLE}ðŸ’œ .baesreps Status${NC}"
    echo "==================="
    echo ""
    echo "ðŸ“ Directories:"
    echo "  Home:     $BAESREPS_HOME"
    echo "  Projects: $BAESREPS_PROJECTS_DIR"
    echo "  Cards:    $BAESREPS_CARDS_DIR"
    echo "  Reps:     $BAESREPS_REPS_DIR"
    echo "  Secrets:  ${BAESREPS_SECRETS_DIR:-$HOME/secrets}"
    echo "  Vaults:   ${BAESREPS_VAULTS_DIR:-$HOME/vaults}"
    echo "  Notes:    ${BAESREPS_NOTES_DIR:-$HOME/notes}"
    echo ""
    
    local project_count=$(find "$BAESREPS_PROJECTS_DIR" -maxdepth 1 -type d 2>/dev/null | wc -l)
    local card_count=$(find "$BAESREPS_CARDS_DIR" -name "*.json" 2>/dev/null | wc -l)
    local rep_count=$(find "$BAESREPS_REPS_DIR" -name "*.json" 2>/dev/null | wc -l)
    
    echo "ðŸ“Š Statistics:"
    echo "  Projects: $((project_count - 1))"
    echo "  Cards:    $card_count"
    echo "  Reps:     $rep_count"
    
    # Calculate total points
    local total_points=0
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        shopt -s nullglob
        for card in "$BAESREPS_CARDS_DIR"/*.json; do
            if [ -f "$card" ]; then
                points=$(grep -o '"points":[^,}]*' "$card" 2>/dev/null | cut -d: -f2 | tr -d ' ' || echo 0)
                total_points=$((total_points + points))
            fi
        done
        shopt -u nullglob
    fi
    echo "  Total Points: $total_points"
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        init)
            cmd_init "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        project)
            exec baesreps-project "$@"
            ;;
        card)
            exec baesreps-card "$@"
            ;;
        calc)
            exec baesreps-calc "$@"
            ;;
        secret)
            exec baesreps-secret "$@"
            ;;
        vault)
            exec baesreps-vault "$@"
            ;;
        rep)
            exec baesreps-rep "$@"
            ;;
        note)
            exec baesreps-note "$@"
            ;;
        version|--version|-v)
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'baesreps help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
