#!/usr/bin/env bash
# baesreps-calc - Calculator for .baesreps
# Calculate reps/points for projects and tasks
#
# Usage: baesreps-calc <command> [args]

set -e

BAESREPS_PROJECTS_DIR="${BAESREPS_PROJECTS_DIR:-$HOME/projects}"
BAESREPS_CARDS_DIR="${BAESREPS_CARDS_DIR:-$HOME/cards}"

# Color codes
PURPLE='\033[0;35m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# =============================================================================
# INPUT VALIDATION
# =============================================================================

validate_name() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Error: Name cannot be empty${NC}" >&2
        return 1
    fi
    if [[ "$name" == *".."* ]] || [[ "$name" == *"/"* ]] || [[ "$name" == *"\\"* ]]; then
        echo -e "${RED}Error: Name cannot contain path traversal characters${NC}" >&2
        return 1
    fi
    if [[ "$name" =~ [^a-zA-Z0-9_-] ]]; then
        echo -e "${RED}Error: Name can only contain alphanumeric characters, underscores, and hyphens${NC}" >&2
        return 1
    fi
    return 0
}

# =============================================================================
# JSON HELPER FUNCTIONS
# =============================================================================

# Get a string value from a JSON file
get_json_string() {
    local file="$1"
    local key="$2"
    cat "$file" | tr '\n' ' ' | grep -oP "\"$key\"\s*:\s*\"\K[^\"]*" 2>/dev/null || echo ""
}

# Get a numeric value from a JSON file
get_json_number() {
    local file="$1"
    local key="$2"
    cat "$file" | tr '\n' ' ' | grep -oP "\"$key\"\s*:\s*\K[0-9]+" 2>/dev/null || echo "0"
}

# Check if a JSON file contains a key with specific value
json_contains() {
    local file="$1"
    local key="$2"
    local value="$3"
    local content=$(cat "$file" | tr '\n' ' ')
    echo "$content" | grep -q "\"$key\"\s*:\s*\"$value\""
}

# =============================================================================
# CALCULATION FUNCTIONS
# =============================================================================

calc_project_total() {
    local project="$1"
    local total=0
    
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            if json_contains "$card" "project" "$project"; then
                local pts=$(get_json_number "$card" "points")
                if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                    total=$((total + pts))
                fi
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    echo $total
}

calc_project_completed() {
    local project="$1"
    local total=0
    
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            if json_contains "$card" "project" "$project" && json_contains "$card" "status" "completed"; then
                local pts=$(get_json_number "$card" "points")
                if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                    total=$((total + pts))
                fi
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    echo $total
}

calc_project_pending() {
    local project="$1"
    local total=0
    
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            if json_contains "$card" "project" "$project" && ! json_contains "$card" "status" "completed"; then
                local pts=$(get_json_number "$card" "points")
                if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                    total=$((total + pts))
                fi
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    echo $total
}

calc_all_total() {
    local total=0
    
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            local pts=$(get_json_number "$card" "points")
            if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                total=$((total + pts))
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    echo $total
}

calc_all_completed() {
    local total=0
    
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            if json_contains "$card" "status" "completed"; then
                local pts=$(get_json_number "$card" "points")
                if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                    total=$((total + pts))
                fi
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    echo $total
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_total() {
    local project="$1"
    
    if [ -n "$project" ]; then
        if ! validate_name "$project"; then
            return 1
        fi
        local total=$(calc_project_total "$project")
        echo -e "${PURPLE}üìä Total points for ${BOLD}$project${NC}${PURPLE}: ${GREEN}$total${NC}"
    else
        local total=$(calc_all_total)
        echo -e "${PURPLE}üìä Total points (all projects): ${GREEN}$total${NC}"
    fi
}

cmd_completed() {
    local project="$1"
    
    if [ -n "$project" ]; then
        if ! validate_name "$project"; then
            return 1
        fi
        local completed=$(calc_project_completed "$project")
        echo -e "${PURPLE}‚úÖ Completed points for ${BOLD}$project${NC}${PURPLE}: ${GREEN}$completed${NC}"
    else
        local completed=$(calc_all_completed)
        echo -e "${PURPLE}‚úÖ Completed points (all projects): ${GREEN}$completed${NC}"
    fi
}

cmd_pending() {
    local project="$1"
    
    if [ -n "$project" ]; then
        if ! validate_name "$project"; then
            return 1
        fi
        local pending=$(calc_project_pending "$project")
        echo -e "${PURPLE}‚è≥ Pending points for ${BOLD}$project${NC}${PURPLE}: ${YELLOW}$pending${NC}"
    else
        local all_total=$(calc_all_total)
        local all_completed=$(calc_all_completed)
        local pending=$((all_total - all_completed))
        echo -e "${PURPLE}‚è≥ Pending points (all projects): ${YELLOW}$pending${NC}"
    fi
}

cmd_progress() {
    local project="$1"
    
    if [ -n "$project" ]; then
        if ! validate_name "$project"; then
            return 1
        fi
        
        local total=$(calc_project_total "$project")
        local completed=$(calc_project_completed "$project")
        local pending=$((total - completed))
        
        local percent=0
        if [ $total -gt 0 ]; then
            percent=$((completed * 100 / total))
        fi
        
        echo -e "${PURPLE}üìà Progress for ${BOLD}$project${NC}"
        echo "------------------------------"
        echo -e "  Total:     ${GREEN}$total pts${NC}"
        echo -e "  Completed: ${GREEN}$completed pts${NC}"
        echo -e "  Pending:   ${YELLOW}$pending pts${NC}"
        echo ""
        
        # Progress bar
        local bar_width=30
        local filled=$((percent * bar_width / 100))
        local empty=$((bar_width - filled))
        
        printf "  ["
        printf "${GREEN}"
        for ((i=0; i<filled; i++)); do printf "#"; done
        printf "${NC}"
        for ((i=0; i<empty; i++)); do printf "-"; done
        printf "] ${BOLD}%d%%${NC}\n" "$percent"
    else
        echo -e "${PURPLE}üìà Overall Progress${NC}"
        echo "------------------------------"
        
        local grand_total=0
        local grand_completed=0
        
        for project_dir in "$BAESREPS_PROJECTS_DIR"/*/; do
            if [ -f "${project_dir}project.json" ]; then
                local name=$(basename "$project_dir")
                local total=$(calc_project_total "$name")
                local completed=$(calc_project_completed "$name")
                
                grand_total=$((grand_total + total))
                grand_completed=$((grand_completed + completed))
                
                local percent=0
                if [ $total -gt 0 ]; then
                    percent=$((completed * 100 / total))
                fi
                
                echo -e "  ${CYAN}$name${NC}: $completed/$total pts (${percent}%)"
            fi
        done
        
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        
        local grand_pending=$((grand_total - grand_completed))
        local grand_percent=0
        if [ $grand_total -gt 0 ]; then
            grand_percent=$((grand_completed * 100 / grand_total))
        fi
        
        echo -e "  ${BOLD}Total:${NC}     ${GREEN}$grand_total pts${NC}"
        echo -e "  ${BOLD}Completed:${NC} ${GREEN}$grand_completed pts${NC}"
        echo -e "  ${BOLD}Pending:${NC}   ${YELLOW}$grand_pending pts${NC}"
        echo ""
        
        # Progress bar
        local bar_width=30
        local filled=$((grand_percent * bar_width / 100))
        local empty=$((bar_width - filled))
        
        printf "  ["
        printf "${GREEN}"
        for ((i=0; i<filled; i++)); do printf "#"; done
        printf "${NC}"
        for ((i=0; i<empty; i++)); do printf "-"; done
        printf "] ${BOLD}%d%%${NC}\n" "$grand_percent"
    fi
}

cmd_summary() {
    echo -e "${PURPLE}üíú .baesreps Summary${NC}"
    echo "------------------------------------"
    echo ""
    
    local project_count=0
    local card_count=0
    local total_points=0
    local completed_points=0
    
    # Count projects
    if [ -d "$BAESREPS_PROJECTS_DIR" ]; then
        while IFS= read -r -d '' project_dir; do
            if [ -f "${project_dir}/project.json" ]; then
                project_count=$((project_count + 1))
            fi
        done < <(find "$BAESREPS_PROJECTS_DIR" -maxdepth 1 -mindepth 1 -type d -print0 2>/dev/null)
    fi
    
    # Count cards and points
    if [ -d "$BAESREPS_CARDS_DIR" ]; then
        while IFS= read -r -d '' card; do
            card_count=$((card_count + 1))
            local pts=$(get_json_number "$card" "points")
            if [ -n "$pts" ] && [ "$pts" -gt 0 ]; then
                total_points=$((total_points + pts))
                if json_contains "$card" "status" "completed"; then
                    completed_points=$((completed_points + pts))
                fi
            fi
        done < <(find "$BAESREPS_CARDS_DIR" -maxdepth 1 -name "*.json" -print0 2>/dev/null)
    fi
    
    local pending_points=$((total_points - completed_points))
    local completion_rate=0
    if [ $total_points -gt 0 ]; then
        completion_rate=$((completed_points * 100 / total_points))
    fi
    
    echo "üìÇ Projects:        $project_count"
    echo "üÉè Cards:            $card_count"
    echo ""
    echo "üìä Points:"
    echo -e "   Total:      ${GREEN}$total_points${NC}"
    echo -e "   Completed:  ${GREEN}$completed_points${NC}"
    echo -e "   Pending:    ${YELLOW}$pending_points${NC}"
    echo ""
    echo -e "üìà Completion Rate: ${BOLD}${completion_rate}%${NC}"
}

show_help() {
    echo -e "${PURPLE}üíú .baesreps Calculator${NC}"
    echo "Calculate reps/points for projects and tasks"
    echo ""
    echo "Usage: baesreps-calc <command> [project]"
    echo ""
    echo "Commands:"
    echo "  total [project]      - Calculate total points"
    echo "  completed [project]  - Calculate completed points"
    echo "  pending [project]    - Calculate pending points"
    echo "  progress [project]   - Show progress with visual bar"
    echo "  summary              - Show overall summary"
    echo "  help                 - Show this help"
    echo ""
    echo "Examples:"
    echo "  baesreps-calc total           # Total points all projects"
    echo "  baesreps-calc total myapp     # Total points for myapp"
    echo "  baesreps-calc progress        # Show overall progress"
    echo "  baesreps-calc progress myapp  # Progress for myapp"
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        total)
            cmd_total "$@"
            ;;
        completed|done)
            cmd_completed "$@"
            ;;
        pending|remaining)
            cmd_pending "$@"
            ;;
        progress)
            cmd_progress "$@"
            ;;
        summary|stats)
            cmd_summary "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'baesreps-calc help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
